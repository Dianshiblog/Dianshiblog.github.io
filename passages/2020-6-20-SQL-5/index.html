<!DOCTYPE html>
<html>
  
<head>
  <meta charset="utf-8">
  <meta name="author" content="Liu Dianshi" />
  
  
  <title>「CURD 程序员系列」高性能 SQL 计划 Day 5 | Dianshi Blog</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
    <meta name="keywords" content="SQL,Java,MySQL," />
  

  
  <meta name="description" content="刘点石的小站">

  

  
    <script src="//cdn.jsdelivr.net/npm/leancloud-storage@3.11.1/dist/av-min.js" async></script>
  

  
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script>
  

  

  

  <script>
  // theme-ad's config script
  // it can be used in every script
  
  window.AD_CONFIG = {
    leancloud: {"appid":"Hyq9wkH495DgNHWhDQCOfQSp-gzGzoHsz","appkey":"WaR7nrzhliHj9aVwdQzkdlGd","comment":false,"count":true},
    welcome: {"enable":false,"interval":30},
    start_time: "2019-12-14",
    passwords: ["09497f74cc589b68dd086fecc6ae388fe3eb25076d7bc235f48764ec1faaf4d1", ],
    is_post: true,
    lock: false,
    author: "Liu Dianshi",
    share: {"twitter":true,"facebook":true,"weibo":true,"qq":true,"wechat":true},
    mathjax: true,
    page_type: "",
    root: "/"
  };
</script>

  
<script src="/vendor/sha256.min.js"></script>
<script src="/js/auth.js"></script>
<script src="/js/index.js"></script>
<script src="/vendor/qrcode.min.js"></script>


  
    <link rel="icon" href="/images/favicon.ico">
    <link rel="apple-touch-icon" href="/images/touch-icon.png">
  

  <link href="//netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

  
<link rel="stylesheet" href="/css/index.css">
<link rel="stylesheet" href="/styles/components/highlight/highlight.css">


  
<meta name="generator" content="Hexo 4.1.1"></head>
  <body>
    <header class="site-header">
  <div class="site-header-brand">
    
      <span class="site-header-brand-title">
        <a href="/">Dianshi</a>
      </span>
    
    
      <span class="site-header-brand-motto"> | 安静写些东西</span>
    
  </div>
  <div class="site-header-right">
    <nav class="site-header-navigation">
      
        <a href="/" target="_self">首页</a>
      
        <a href="/archives/" target="_self">归档</a>
      
        <a href="/tags/" target="_self">标签</a>
      
        <a href="/categories/" target="_self">分类</a>
      
        <a href="/about/" target="_self">关于</a>
      
    </nav>
    <div class="site-header-btn">
      
        <a href="https://github.com/LiuDianshi" target="_blank" id="site-github">
          <i class="fa fa-github-alt"></i>
        </a>
      
      <a href="javascript:void(0);" id="site-search">
        <i class="fa fa-search"></i>
      </a>
      <a href="javascript:void(0);" id="site-nav-btn">
        <i class="fa fa-ellipsis-v"></i>
      </a>
    </div>
  </div>
</header>
<nav class="table-content" id="site-nav">
  <div class="table-content-title">
    <span>导航</span>
  </div>
  <div class="table-content-main">
    <ol class="toc">
      
        <li class="toc-item">
          <a href="/" target="_self">
            首页
          </a>
        </li>
      
        <li class="toc-item">
          <a href="/archives/" target="_self">
            归档
          </a>
        </li>
      
        <li class="toc-item">
          <a href="/tags/" target="_self">
            标签
          </a>
        </li>
      
        <li class="toc-item">
          <a href="/categories/" target="_self">
            分类
          </a>
        </li>
      
        <li class="toc-item">
          <a href="/about/" target="_self">
            关于
          </a>
        </li>
      
    </ol>
  </div>
</nav>
<div id="site-process"></div>
    <main>
      
  <div class="passage">
  <div class="passage-meta">
    <span>
      <i class="fa fa-calendar"></i>2020-06-20
    </span>
    
      <span>
        | <a href="/categories/SQL/"><i class="fa fa-bookmark"></i>SQL</a>
      </span>
    
    
      <span>
        | <i class="fa fa-unlock-alt"></i>UNLOCK
      </span>
    
  </div>
  <h1 class="passage-title">
    「CURD 程序员系列」高性能 SQL 计划 Day 5
  </h1>
  
  <article class="passage-article">
    <h1 id="高性能-SQL-计划-Day-5"><a href="#高性能-SQL-计划-Day-5" class="headerlink" title="高性能 SQL 计划 Day 5"></a>高性能 SQL 计划 Day 5</h1><p>今天继续学习《MySQL 必知必会》，今天是23章-30章的内容。</p>
<h2 id="Ch-23-使用存储过程"><a href="#Ch-23-使用存储过程" class="headerlink" title="Ch 23.使用存储过程"></a>Ch 23.使用存储过程</h2><p>所谓的存储过程，就是在需要针对多个表进行多条SQL语句处理的复杂场合，将多条SQL语句保存成的一个集合。存储过程相当于一个SQL的集合函数，封装了若干条SQL语句。</p>
<h3 id="1-存储过程的优缺点："><a href="#1-存储过程的优缺点：" class="headerlink" title="1.存储过程的优缺点："></a>1.存储过程的优缺点：</h3><p>存储过程主要有以下优点：</p>
<ul>
<li><p>简单</p>
<ul>
<li>通过把处理封装在容易使用的单元中，简化复杂的操作。</li>
<li>由于不要求反复建立一系列处理步骤，这保证了数据的完整性。</li>
</ul>
</li>
<li><p>安全</p>
<p>简化对变动的管理。如果表名、列名或业务逻辑（或别的内容）有变化，只需要更改存储过程的代码。使用它的人员甚至不需要知道这些变化。通过存储过程可以限制对基础数据的访问，减少了数据讹传。</p>
</li>
<li><p>高性能</p>
<ul>
<li>提高性能。因为使用存储过程比使用单独的SQL语句要快。</li>
<li>存在一些只能用在单个请求中的MySQL元素和特性，存储过程可以使用它们来编写功能更强更灵活的代码。</li>
</ul>
</li>
</ul>
<p>存储过程的缺点也很明显：编写存储过程要比编写基本的SQL语句复杂很多；存储过程也往往存在一定的限制，比如只允许用户使用存储过程而不允许创建。</p>
<h3 id="2-使用存储过程"><a href="#2-使用存储过程" class="headerlink" title="2.使用存储过程"></a>2.使用存储过程</h3><h4 id="调用存储过程"><a href="#调用存储过程" class="headerlink" title="调用存储过程"></a>调用存储过程</h4><p>MySQL 调用执行过程使用的是 CALL关键字，如：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CALL</span> productpricing(@pricelow,</span><br><span class="line">                    @pricehigh,</span><br><span class="line">                    @priceaverage);                    </span><br><span class="line"><span class="comment">#CALL 存储过程名（参数列表）;</span></span><br></pre></td></tr></table></figure>

<h4 id="创建存储过程"><a href="#创建存储过程" class="headerlink" title="创建存储过程"></a>创建存储过程</h4><p>以下创建了一个简单的无参的存储过程：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> productpricing()</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">   <span class="keyword">SELECT</span> <span class="keyword">Avg</span>(prod_price) <span class="keyword">AS</span> priceaverage</span><br><span class="line">   <span class="keyword">FROM</span> products;</span><br><span class="line"><span class="keyword">END</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#CREATE PROCEDURE (参数列表)</span></span><br><span class="line"><span class="comment">#BEGIN</span></span><br><span class="line"><span class="comment">#	SQL 语句</span></span><br><span class="line"><span class="comment">#END;</span></span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong>如果使用的是命令行版的MySQL，存储过程体中的SQL语句中的<code>;</code>会被作为分隔符使用，造成错误。解决措施是临时临时更改命令行版MySQL的语句分隔符：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#将分隔符替换为//</span></span><br><span class="line">DELIMITER //</span><br><span class="line"></span><br><span class="line">  <span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> productpricing()</span><br><span class="line">  <span class="keyword">BEGIN</span></span><br><span class="line">     <span class="keyword">SELECT</span> <span class="keyword">Avg</span>(prod_price) <span class="keyword">AS</span> priceaverage</span><br><span class="line">     <span class="keyword">FROM</span> products;</span><br><span class="line">  <span class="keyword">END</span> //</span><br><span class="line"></span><br><span class="line">  DELIMITER ;</span><br><span class="line"><span class="comment">#将分隔符改回;</span></span><br></pre></td></tr></table></figure>

<p>除了\符号外，其他的符号都可以作为命令行 MySQL 的分隔符。</p>
<p>调用上述存储过程：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CALL</span> productpricing();</span><br></pre></td></tr></table></figure>

<h4 id="删除存储过程"><a href="#删除存储过程" class="headerlink" title="删除存储过程"></a>删除存储过程</h4><p>删除上述存储过程：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">PROCEDURE</span> productpricing；</span><br><span class="line"><span class="comment">#存储过程名后面不需要带()</span></span><br><span class="line"><span class="comment">#仅存在时删除：DROP PROCEDURE IF EXISTS</span></span><br></pre></td></tr></table></figure>

<h4 id="使用参数"><a href="#使用参数" class="headerlink" title="使用参数"></a>使用参数</h4><p>使用存储过程时，常常将结果存储到某个变量里面，因此需要在存储过程中使用参数传递变量：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> productpricing(</span><br><span class="line">   <span class="keyword">OUT</span> pl <span class="built_in">DECIMAL</span>(<span class="number">8</span>,<span class="number">2</span>),</span><br><span class="line">   <span class="keyword">OUT</span> ph <span class="built_in">DECIMAL</span>(<span class="number">8</span>,<span class="number">2</span>),</span><br><span class="line">   <span class="keyword">OUT</span> pa <span class="built_in">DECIMAL</span>(<span class="number">8</span>,<span class="number">2</span>)</span><br><span class="line">)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">   <span class="keyword">SELECT</span> <span class="keyword">Min</span>(prod_price)</span><br><span class="line">   <span class="keyword">INTO</span> pl</span><br><span class="line">   <span class="keyword">FROM</span> products;</span><br><span class="line">   <span class="keyword">SELECT</span> <span class="keyword">Max</span>(prod_price)</span><br><span class="line">   <span class="keyword">INTO</span> ph</span><br><span class="line">   <span class="keyword">FROM</span> products;</span><br><span class="line">   <span class="keyword">SELECT</span> <span class="keyword">Avg</span>(prod_price)</span><br><span class="line">   <span class="keyword">INTO</span> pa</span><br><span class="line">   <span class="keyword">FROM</span> products;</span><br><span class="line"><span class="keyword">END</span>;</span><br></pre></td></tr></table></figure>

<p>此存储过程接受3个参数：pl存储产品最低价格，ph存储产品最高价格，pa存储产品平均价格。每个参数必须具有指定的类型，这里使用十进制值。关键字OUT指出相应的参数用来从存储过程传出一个值（返回给调用者）。MySQL支持<strong>IN（传递给存储过程）、OUT（从存储过程传出，如这里所用）和INOUT（对存储过程传入和传出）</strong>类型的参数。存储过程的代码位于BEGIN和END语句内，如前所见，它们是一系列SELECT语句，用来检索值，然后保存到相应的变量（通过指定INTO关键字）。</p>
<p><strong>注意：</strong>使用变量时，尤其是对变量进行赋值时需要注意变量的数据类型。</p>
<p>调用上述存储过程，并输出结果：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CALL</span> productpricing(@pricelow,</span><br><span class="line">                    @pricehigh,</span><br><span class="line">                    @priceaverage);</span><br><span class="line"><span class="keyword">SELECT</span> @priceaverage;</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong>所有MySQL变量都需要使用<code>@</code>。</p>
<p>以下是一个使用 IN 和 OUT 变量的存储过程：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> ordertotal(</span><br><span class="line">   <span class="keyword">IN</span> onumber <span class="built_in">INT</span>,</span><br><span class="line">   <span class="keyword">OUT</span> ototal <span class="built_in">DECIMAL</span>(<span class="number">8</span>,<span class="number">2</span>)</span><br><span class="line">)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">   <span class="keyword">SELECT</span> <span class="keyword">Sum</span>(item_price*quantity)</span><br><span class="line">   <span class="keyword">FROM</span> orderitems</span><br><span class="line">   <span class="keyword">WHERE</span> order_num = onumber</span><br><span class="line">   <span class="keyword">INTO</span> ototal;</span><br><span class="line"><span class="keyword">END</span>;</span><br></pre></td></tr></table></figure>

<p>调用上述存储过程并输出结果：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CALL</span> ordertotal(<span class="number">20005</span>,@total);</span><br><span class="line"><span class="keyword">SELECT</span> @total;</span><br></pre></td></tr></table></figure>

<h4 id="建立智能存储过程"><a href="#建立智能存储过程" class="headerlink" title="建立智能存储过程"></a>建立智能存储过程</h4><p>以下是声明了一个复杂存储过程：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Name: ordertotal</span></span><br><span class="line"><span class="comment">-- Parameters: onumber = order number</span></span><br><span class="line"><span class="comment">--             taxable = 0 if not taxable, 1 if taxable</span></span><br><span class="line"><span class="comment">--             ototal = order total variable</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> ordertotal(</span><br><span class="line">   <span class="keyword">IN</span> onumber <span class="built_in">INT</span>,</span><br><span class="line">   <span class="keyword">IN</span> taxable <span class="built_in">BOOLEAN</span>,</span><br><span class="line">   <span class="keyword">OUT</span> ototal <span class="built_in">DECIMAL</span>(<span class="number">8</span>,<span class="number">2</span>)</span><br><span class="line">) <span class="keyword">COMMENT</span> <span class="string">'Obtain order total, optionally adding tax'</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">-- Declare variable for total</span></span><br><span class="line">   <span class="keyword">DECLARE</span> total <span class="built_in">DECIMAL</span>(<span class="number">8</span>,<span class="number">2</span>);</span><br><span class="line">   <span class="comment">-- Declare tax percentage</span></span><br><span class="line">   <span class="keyword">DECLARE</span> taxrate <span class="built_in">INT</span> <span class="keyword">DEFAULT</span> <span class="number">6</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">-- Get the order total</span></span><br><span class="line">   <span class="keyword">SELECT</span> <span class="keyword">Sum</span>(item_price*quantity)</span><br><span class="line">   <span class="keyword">FROM</span> orderitems</span><br><span class="line">   <span class="keyword">WHERE</span> order_num = onumber</span><br><span class="line">   <span class="keyword">INTO</span> total;</span><br><span class="line"></span><br><span class="line">   <span class="comment">-- Is this taxable?</span></span><br><span class="line">   IF taxable THEN</span><br><span class="line">      <span class="comment">-- Yes, so add taxrate to the total</span></span><br><span class="line">      <span class="keyword">SELECT</span> total+(total/<span class="number">100</span>*taxrate) <span class="keyword">INTO</span> total;</span><br><span class="line">   <span class="keyword">END</span> <span class="keyword">IF</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">-- And finally, save to out variable</span></span><br><span class="line">   <span class="keyword">SELECT</span> total <span class="keyword">INTO</span> ototal;</span><br><span class="line"></span><br><span class="line"><span class="keyword">END</span>;</span><br></pre></td></tr></table></figure>

<p>注意以下几点：</p>
<ul>
<li>增加了注释 <code>--</code>。在编写复杂的存储过程时，添加一定的注视非常重要。</li>
<li>添加了另外一个参数taxable，它是一个布尔值，传入变量为0或1。</li>
<li>用DECLARE语句定义了两个局部变量。</li>
<li>IF语句检查taxable是否为真，如果为真，则用另一SELECT语句增加营业税到局部变量total。最后，用另一SELECT语句将total（它增加或许不增加营业税）保存到ototal。</li>
<li>添加了COMMENT输出信息，相当于日志的作用，其信息将在SHOW PROCEDURE STATUS的结果中显示。</li>
</ul>
<p>调用上述存储过程，并输出结果：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CALL</span> ordertotal(<span class="number">20005</span>, <span class="number">0</span>, @total);</span><br><span class="line"><span class="keyword">SELECT</span> @total;</span><br></pre></td></tr></table></figure>

<h4 id="检查存储过程"><a href="#检查存储过程" class="headerlink" title="检查存储过程"></a>检查存储过程</h4><p>查看存储过程的创建语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> <span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> ordertotal;</span><br></pre></td></tr></table></figure>

<p>输出存储过程的详细信息：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> <span class="keyword">PROCEDURE</span> <span class="keyword">STATUS</span>;</span><br></pre></td></tr></table></figure>

<p>以上语句会输出全部的存储过程的信息，可以通过以下方式进行过滤：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> <span class="keyword">PROCEDURE</span> <span class="keyword">STATUS</span> <span class="keyword">LIKE</span> <span class="string">'ordertotal'</span>;</span><br></pre></td></tr></table></figure>

<h2 id="Ch-24-使用游标"><a href="#Ch-24-使用游标" class="headerlink" title="Ch 24.使用游标"></a>Ch 24.使用游标</h2><p>SQL 检索语句返回的结果称为结果集，之前的操作无法完成这样的操作：获取下一行，获取前十行等等。这就要使用游标了。游标主要用于交互式应用，其中用户需要滚动屏幕上的数据，并对数据进行浏览或做出更改。不同于其他DBMS，MySQL的游标只能用于存储过程。</p>
<h3 id="1-使用游标"><a href="#1-使用游标" class="headerlink" title="1.使用游标"></a>1.使用游标</h3><p>使用游标涉及几个明确的步骤：</p>
<ul>
<li>在能够使用游标前，必须声明（定义）它。这个过程实际上没有检索数据，它只是定义要使用的SELECT语句。</li>
<li>一旦声明后，必须打开游标以供使用。这个过程用前面定义的SELECT语句把数据实际检索出来。</li>
<li>对于填有数据的游标，根据需要取出（检索）各行。</li>
<li>在结束游标使用时，必须关闭游标。</li>
</ul>
<p>在声明游标后，可根据需要频繁地打开和关闭游标。在游标打开后，可根据需要频繁地执行取操作。</p>
<h4 id="定义游标"><a href="#定义游标" class="headerlink" title="定义游标"></a>定义游标</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> processorders()</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">   <span class="keyword">DECLARE</span> ordernumbers <span class="keyword">CURSOR</span></span><br><span class="line">   <span class="keyword">FOR</span></span><br><span class="line">   <span class="keyword">SELECT</span> ordernum <span class="keyword">FROM</span> orders;</span><br><span class="line"><span class="keyword">END</span>;</span><br></pre></td></tr></table></figure>

<p>游标的命名方式为<code>DECLARE 游标名 CURSOR</code>，需要注意的是，存储过程执行完毕后游标就消失。</p>
<h4 id="打开和关闭游标"><a href="#打开和关闭游标" class="headerlink" title="打开和关闭游标"></a>打开和关闭游标</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#打开游标</span></span><br><span class="line">OPEN ordernumbers;</span><br><span class="line"></span><br><span class="line"><span class="comment">#关闭游标</span></span><br><span class="line">CLOSE ordernumbers;</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong>只有打开游标后才能使用它，在游标使用完毕后需要关闭它以释放资源。即使不手动关闭游标，当存储过程执行完毕游标也会被 MySQL 关闭。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> processorders()</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">   <span class="comment">-- Declare the cursor</span></span><br><span class="line">   <span class="keyword">DECLARE</span> ordernumbers <span class="keyword">CURSOR</span></span><br><span class="line">   <span class="keyword">FOR</span></span><br><span class="line">   <span class="keyword">SELECT</span> order_num <span class="keyword">FROM</span> orders;</span><br><span class="line"></span><br><span class="line">   <span class="comment">-- Open the cursor</span></span><br><span class="line">   OPEN ordernumbers;</span><br><span class="line"></span><br><span class="line">   <span class="comment">-- Close the cursor</span></span><br><span class="line">   CLOSE ordernumbers;</span><br><span class="line"></span><br><span class="line"><span class="keyword">END</span>;</span><br></pre></td></tr></table></figure>

<h4 id="使用游标数据"><a href="#使用游标数据" class="headerlink" title="使用游标数据"></a>使用游标数据</h4><p>在一个游标被打开后，可以使用FETCH语句分别访问它的每一行。FETCH指定检索什么数据（所需的列），检索出来的数据存储在什么地方。它还向前移动游标中的内部行指针，使下一条FETCH语句检索下一行（不重复读取同一行）。</p>
<p>第一个例子是利用FETCH检索第一行</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> processorders()</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">-- Declare local variables</span></span><br><span class="line">   <span class="keyword">DECLARE</span> o <span class="built_in">INT</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">-- Declare the cursor</span></span><br><span class="line">   <span class="keyword">DECLARE</span> ordernumbers <span class="keyword">CURSOR</span></span><br><span class="line">   <span class="keyword">FOR</span></span><br><span class="line">   <span class="keyword">SELECT</span> order_num <span class="keyword">FROM</span> orders;</span><br><span class="line"></span><br><span class="line">   <span class="comment">-- Open the cursor</span></span><br><span class="line">   OPEN ordernumbers;</span><br><span class="line"></span><br><span class="line">   <span class="comment">-- Get order number</span></span><br><span class="line">   <span class="comment">--将检索出的数据存放在局部变量o中</span></span><br><span class="line">   FETCH ordernumbers INTO o;</span><br><span class="line"></span><br><span class="line">   <span class="comment">-- Close the cursor</span></span><br><span class="line">   CLOSE ordernumbers;</span><br><span class="line"></span><br><span class="line"><span class="keyword">END</span>;</span><br></pre></td></tr></table></figure>

<p>下一个例子是循环检索数据，从第一行到最后一行</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> processorders()</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">-- Declare local variables</span></span><br><span class="line">   <span class="keyword">DECLARE</span> done <span class="built_in">BOOLEAN</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>;</span><br><span class="line">   <span class="keyword">DECLARE</span> o <span class="built_in">INT</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">-- Declare the cursor</span></span><br><span class="line">   <span class="keyword">DECLARE</span> ordernumbers <span class="keyword">CURSOR</span></span><br><span class="line">   <span class="keyword">FOR</span></span><br><span class="line">   <span class="keyword">SELECT</span> order_num <span class="keyword">FROM</span> orders;</span><br><span class="line"></span><br><span class="line">   <span class="comment">-- Declare continue handler</span></span><br><span class="line">   <span class="comment">-- SQLSTATE '02000'指的是未找到的错误，强行类比的话像是NullPointerException</span></span><br><span class="line">   <span class="keyword">DECLARE</span> CONTINUE <span class="keyword">HANDLER</span> <span class="keyword">FOR</span> <span class="keyword">SQLSTATE</span> <span class="string">'02000'</span> <span class="keyword">SET</span> done=<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">-- Open the cursor</span></span><br><span class="line">   OPEN ordernumbers;</span><br><span class="line"></span><br><span class="line">   <span class="comment">-- Loop through all rows</span></span><br><span class="line">   REPEAT</span><br><span class="line"></span><br><span class="line">      <span class="comment">-- Get order number</span></span><br><span class="line">      FETCH ordernumbers INTO o;</span><br><span class="line"></span><br><span class="line">   <span class="comment">-- End of loop</span></span><br><span class="line">   UNTIL done <span class="keyword">END</span> <span class="keyword">REPEAT</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">-- Close the cursor</span></span><br><span class="line">   CLOSE ordernumbers;</span><br><span class="line"></span><br><span class="line"><span class="keyword">END</span>;</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong>DECLARE语句的发布存在特定的次序。用DECLARE语句定义的局部变量必须在定义任意游标或句柄之前定义，而句柄必须在游标之后定义。不遵守此顺序将产生错误消息。<br>接下来是一个复杂的例子，其中ordertotal是上一章定义的一个计算税率的存储过程：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> processorders()</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">-- Declare local variables</span></span><br><span class="line">   <span class="keyword">DECLARE</span> done <span class="built_in">BOOLEAN</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>;</span><br><span class="line">   <span class="keyword">DECLARE</span> o <span class="built_in">INT</span>;</span><br><span class="line">   <span class="keyword">DECLARE</span> t <span class="built_in">DECIMAL</span>(<span class="number">8</span>,<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">   <span class="comment">-- Declare the cursor</span></span><br><span class="line">   <span class="keyword">DECLARE</span> ordernumbers <span class="keyword">CURSOR</span></span><br><span class="line">   <span class="keyword">FOR</span></span><br><span class="line">   <span class="keyword">SELECT</span> order_num <span class="keyword">FROM</span> orders;</span><br><span class="line">   <span class="comment">-- Declare continue handler</span></span><br><span class="line">   <span class="keyword">DECLARE</span> CONTINUE <span class="keyword">HANDLER</span> <span class="keyword">FOR</span> <span class="keyword">SQLSTATE</span> <span class="string">'02000'</span> <span class="keyword">SET</span> done=<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">-- Create a table to store the results</span></span><br><span class="line">   <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> ordertotals</span><br><span class="line">      (order_num <span class="built_in">INT</span>, total <span class="built_in">DECIMAL</span>(<span class="number">8</span>,<span class="number">2</span>));</span><br><span class="line"></span><br><span class="line">   <span class="comment">-- Open the cursor</span></span><br><span class="line">   OPEN ordernumbers;</span><br><span class="line"></span><br><span class="line">   <span class="comment">-- Loop through all rows</span></span><br><span class="line">   REPEAT</span><br><span class="line"></span><br><span class="line">      <span class="comment">-- Get order number</span></span><br><span class="line">      FETCH ordernumbers INTO o;</span><br><span class="line"></span><br><span class="line">      <span class="comment">-- Get the total for this order</span></span><br><span class="line">      <span class="keyword">CALL</span> ordertotal(o, <span class="number">1</span>, t);</span><br><span class="line"></span><br><span class="line">      <span class="comment">-- Insert order and total into ordertotals</span></span><br><span class="line">      <span class="keyword">INSERT</span> <span class="keyword">INTO</span> ordertotals(order_num, total)</span><br><span class="line">      <span class="keyword">VALUES</span>(o, t);</span><br><span class="line"></span><br><span class="line">   <span class="comment">-- End of loop</span></span><br><span class="line">   UNTIL done <span class="keyword">END</span> <span class="keyword">REPEAT</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">-- Close the cursor</span></span><br><span class="line">   CLOSE ordernumbers;</span><br><span class="line"></span><br><span class="line"><span class="keyword">END</span>;</span><br></pre></td></tr></table></figure>

<p>在这个存储过程中，将检索出来的数据存储到新表中。</p>
<h2 id="Ch-25-使用触发器"><a href="#Ch-25-使用触发器" class="headerlink" title="Ch 25.使用触发器"></a>Ch 25.使用触发器</h2><p>如果想使得某些语句在一些事件发生后自动执行，如每当订购一个产品时，都从库存数量中减去订购的数量；无论何时删除一行，都在某个存档表中保留一个副本。想要完成这样的操作，就要使用触发器。</p>
<p>触发器是MySQL响应以下任意语句而自动执行的一组MySQL语句：</p>
<ul>
<li>DELETE；</li>
<li>INSERT；</li>
<li>UPDATE。</li>
</ul>
<p>其他MySQL语句不支持触发器。</p>
<h3 id="1-创建触发器"><a href="#1-创建触发器" class="headerlink" title="1.创建触发器"></a>1.创建触发器</h3><p>创建触发器需要提供以下信息：</p>
<ul>
<li>唯一的触发器名；</li>
<li>触发器关联的表；</li>
<li>触发器应该响应的活动（DELETE、INSERT或UPDATE）；</li>
<li>触发器何时执行（处理之前或之后）。</li>
</ul>
<p>需要注意的是，最好是保持每个数据库的触发器名唯一。另外，只有表支持触发器，视图不支持、临时表也不支持。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> newproduct <span class="keyword">AFTER</span> <span class="keyword">INSERT</span> <span class="keyword">ON</span> products</span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="keyword">ROW</span> <span class="keyword">SELECT</span> <span class="string">'Product added'</span>;</span><br></pre></td></tr></table></figure>

<p>上述语句对 products 定义了一个触发器，每当对该表进行插入操作后，对每个插入行显示“Product added”消息。</p>
<p>MySQL 触发器按每个表每个事件每次地定义，每个表每个事件每次只允许一个触发器。因此，每个表最多支持6个触发器，即INSERT、DELETE、UPDATE的执行前和执行后。</p>
<p><strong>注意：</strong>在MySQL中，如果BEFORE触发器失败，则不会执行请求的操作；如果BEFORE触发器失败或者语句本身失败，也不会执行AFTER触发器操作。</p>
<h3 id="2-删除触发器"><a href="#2-删除触发器" class="headerlink" title="2.删除触发器"></a>2.删除触发器</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TRIGGER</span> newproduct;</span><br></pre></td></tr></table></figure>

<h3 id="3-使用触发器"><a href="#3-使用触发器" class="headerlink" title="3.使用触发器"></a>3.使用触发器</h3><h4 id="INSERT触发器"><a href="#INSERT触发器" class="headerlink" title="INSERT触发器"></a>INSERT触发器</h4><p>INSERT触发器在INSERT语句执行之前或之后执行。需要知道以下几点：</p>
<ul>
<li>在INSERT触发器代码内，可引用一个名为NEW的虚拟表，访问被插入的行；</li>
<li>在BEFORE INSERT触发器中，NEW中的值也可以被更新（允许更改被插入的值）；</li>
<li>对于AUTO_INCREMENT列，NEW在INSERT执行之前包含0，在INSERT执行之后包含新的自动生成值。</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> neworder <span class="keyword">AFTER</span> <span class="keyword">INSERT</span> <span class="keyword">ON</span> orders</span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="keyword">ROW</span> <span class="keyword">SELECT</span> NEW.order_num;</span><br></pre></td></tr></table></figure>

<p>上述语句定义了一个 neworder 的触发器，在对orders表进行插入操作后对于每个插入行显示该新插入记录的order_num属性值。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#运行如下语句</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders(order_date, cust_id)</span><br><span class="line"><span class="keyword">VALUES</span>(<span class="keyword">Now</span>(), <span class="number">10001</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">#可得到如下输出</span></span><br><span class="line">+<span class="comment">-----------+</span></span><br><span class="line">| order_num |</span><br><span class="line">+<span class="comment">-----------+</span></span><br><span class="line">|     20010 |</span><br><span class="line">+<span class="comment">-----------+</span></span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong>BEFORE触发器多用于数据的验证和净化，而AFTER触发器多用于显示提示信息。</p>
<h4 id="DELETE触发器"><a href="#DELETE触发器" class="headerlink" title="DELETE触发器"></a>DELETE触发器</h4><p>DELETE触发器在DELETE语句执行之前或之后执行。需要知道以下两点：</p>
<ul>
<li>在DELETE触发器代码内，你可以引用一个名为OLD的虚拟表，访问被删除的行；</li>
<li>OLD中的值全都是只读的，不能更新。</li>
</ul>
<p>下面的例子演示使用OLD将要被删除的行保存到一个存档表中：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> deleteorder <span class="keyword">BEFORE</span> <span class="keyword">DELETE</span> <span class="keyword">ON</span> orders</span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="keyword">ROW</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">   <span class="keyword">INSERT</span> <span class="keyword">INTO</span> archive_orders(order_num, order_date, cust_id)</span><br><span class="line">   <span class="keyword">VALUES</span>(OLD.order_num, OLD.order_date, OLD.cust_id);</span><br><span class="line"><span class="keyword">END</span>;</span><br><span class="line"><span class="comment">#触发器体可以使用BEGIN和END包裹多条SQL语句。</span></span><br></pre></td></tr></table></figure>

<p>根据前文所提到的，如果BEFORE触发器执行失败，则说明存档失败，因此不会执行删除操作。</p>
<h4 id="UPDATE触发器"><a href="#UPDATE触发器" class="headerlink" title="UPDATE触发器"></a>UPDATE触发器</h4><p>UPDATE触发器在UPDATE语句执行之前或之后执行。需要知道以下几点：</p>
<ul>
<li>在UPDATE触发器代码中，你可以引用一个名为OLD的虚拟表访问以前（UPDATE语句前）的值，引用一个名为NEW的虚拟表访问新更新的值；</li>
<li>在BEFORE UPDATE触发器中，NEW中的值可能也被更新（允许更改将要用于UPDATE语句中的值）；</li>
<li>OLD中的值全都是只读的，不能更新。</li>
</ul>
<p>下面的例子保证州名缩写总是大写（不管UPDATE语句中给出的是大写还是小写）：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> updatevendor <span class="keyword">BEFORE</span> <span class="keyword">UPDATE</span> <span class="keyword">ON</span> vendors</span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="keyword">ROW</span> <span class="keyword">SET</span> NEW.vend_state = <span class="keyword">Upper</span>(NEW.vend_state);</span><br></pre></td></tr></table></figure>

<h4 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h4><p>以下是原书中所写的触发器注意事项：</p>
<ul>
<li>与其他DBMS相比，MySQL5中支持的触发器相当初级。未来的MySQL版本中有一些改进和增强触发器支持的计划。</li>
<li>创建触发器可能需要特殊的安全访问权限，但是，触发器的执行是自动的。如果INSERT、UPDATE或DELETE语句能够执行，则相关的触发器也能执行。</li>
<li>应该用触发器来保证数据的一致性（大小写、格式等）。在触发器中执行这种类型的处理的优点是它总是进行这种处理，而且是透明地进行，与客户机应用无关。</li>
<li>触发器的一种非常有意义的使用是创建审计跟踪。使用触发器，把更改（如果需要，甚至还有之前和之后的状态）记录到另一个表非常容易。</li>
<li>遗憾的是，MySQL触发器中不支持CALL语句。这表示不能从触发器内调用存储过程。所需的存储过程代码需要复制到触发器内。</li>
</ul>
<h2 id="Ch-26-管理事务处理"><a href="#Ch-26-管理事务处理" class="headerlink" title="Ch 26.管理事务处理"></a>Ch 26.管理事务处理</h2><p>正如前文所讲的，并非所有的数据库引擎都支持事务处理，MySQL最常用的引擎中，InnoDB支持事务而MyISAM不支持。</p>
<p>事务处理（transactionprocessing）可以用来维护数据库的完整性，它保证成批的MySQL操作要么完全执行，要么完全不执行，以保证数据库不包含不完整的操作结果。如果没有错误发生，整组语句提交给（写到）数据库表。如果发生错误，则进行回退（撤销）以恢复数据库到某个已知且安全的状态。</p>
<p>首先定义几个概念：</p>
<ul>
<li>事务（transaction）指一组SQL语句；</li>
<li>回退（rollback）指撤销指定SQL语句的过程；</li>
<li>提交（commit）指将未存储的SQL语句结果写入数据库表；</li>
<li>保留点（savepoint）指事务处理中设置的临时占位符（place-holder），你可以对它发布回退（与回退整个事务处理不同）。</li>
</ul>
<h3 id="1-控制事务处理"><a href="#1-控制事务处理" class="headerlink" title="1.控制事务处理"></a>1.控制事务处理</h3><p>管理事务处理的关键在于将SQL语句组分解为逻辑块，并明确规定数据何时应该回退，何时不应该回退。<br>MySQL使用下面的语句来标识事务的开始：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">START TRANSACTION</span><br></pre></td></tr></table></figure>

<h4 id="使用ROLLBACK"><a href="#使用ROLLBACK" class="headerlink" title="使用ROLLBACK"></a>使用ROLLBACK</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> ordertotals;</span><br><span class="line"><span class="keyword">START</span> <span class="keyword">TRANSACTION</span>;</span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> ordertotals;</span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> ordertotals;</span><br><span class="line"><span class="keyword">ROLLBACK</span>;</span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> ordertotals;</span><br></pre></td></tr></table></figure>

<p>上述语句开启事务后将ordertotals表中的记录全部删除，然后回滚事务，将数据库状态恢复至刚刚开启事务时。</p>
<p><strong>注意：</strong>只能回退INSERT、UPDATE、DELETE语句，SELECT语句回退没有意义。不能回退CREATE和DROP，虽然可以在事务处理块中使用这两种语句，但是执行回退他们不会被撤销。</p>
<h4 id="使用COMMIT"><a href="#使用COMMIT" class="headerlink" title="使用COMMIT"></a>使用COMMIT</h4><p>一般的MySQL语句都是直接针对数据库表执行和编写的。这就是所谓的隐含提交（implicitcommit），即提交（写或保存）操作是自动进行的。但是，在事务处理块中，提交不会隐含地进行。为进行明确的提交，使用COMMIT语句。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">START</span> <span class="keyword">TRANSACTION</span>;</span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> orderitems <span class="keyword">WHERE</span> order_num = <span class="number">20010</span>;</span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> orders <span class="keyword">WHERE</span> order_num = <span class="number">20010</span>;</span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br></pre></td></tr></table></figure>

<p>最后的COMMIT语句仅在不出错时写出更改。如果第一条DELETE起作用，但第二条失败，则DELETE不会提交（实际上，它是被自动撤销的）。</p>
<p><strong>注意：</strong>当COMMIT或ROLLBACK语句执行后，事务会自动关闭（将来的更改会隐含提交）。</p>
<h4 id="使用保留点"><a href="#使用保留点" class="headerlink" title="使用保留点"></a>使用保留点</h4><p>更复杂的事务处理可能需要部分提交或回退，为了支持回退部分事务处理，必须能在事务处理块中合适的位置放置占位符。这样，如果需要回退，可以回退到某个占位符。这些占位符称为保留点。为了创建占位符，可如下使用SAVEPOINT语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SAVEPOINT</span> delete1;</span><br><span class="line"></span><br><span class="line"><span class="comment">#回退到保留点</span></span><br><span class="line"><span class="keyword">ROLLBACK</span> <span class="keyword">TO</span> delete1;</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong>在进行复杂的事务操作时，可以尽可能多地设置保留点，这样可以灵活回退。保留点在事务完成后会自动释放，但也可以使用<code>RELEASE SAVEPOINT</code>明确地释放保留点。</p>
<h3 id="2-更改默认的自动提交"><a href="#2-更改默认的自动提交" class="headerlink" title="2.更改默认的自动提交"></a>2.更改默认的自动提交</h3><p>默认的MySQL行为是自动提交所有更改。换句话说，任何时候你执行一条MySQL语句，该语句实际上都是针对表执行的，而且所做的更改立即生效。为指示MySQL不自动提交更改，需要使用以下语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> autocommit=<span class="number">0</span>;</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong>autocommit标志是针对每个连接而不是服务器的。</p>
<h2 id="Ch-27-全球化和本地化"><a href="#Ch-27-全球化和本地化" class="headerlink" title="Ch 27.全球化和本地化"></a>Ch 27.全球化和本地化</h2><h3 id="1-使用字符集和校正顺序"><a href="#1-使用字符集和校正顺序" class="headerlink" title="1.使用字符集和校正顺序"></a>1.使用字符集和校正顺序</h3><p>查看MySQL所支持字符集的完整列表：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> <span class="built_in">CHARACTER</span> <span class="keyword">SET</span>;</span><br></pre></td></tr></table></figure>

<p>查看所支持的校正顺序的完整列表：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> <span class="keyword">COLLATION</span>;</span><br></pre></td></tr></table></figure>

<p>确定所使用的字符集和校正顺序：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> <span class="keyword">VARIABLES</span> <span class="keyword">LIKE</span> <span class="string">'character%'</span>;</span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">VARIABLES</span> <span class="keyword">LIKE</span> <span class="string">'collation%'</span>;</span><br></pre></td></tr></table></figure>

<p>在创建表时指定字符集和校正顺序：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> mytable</span><br><span class="line">(</span><br><span class="line">   columnn1   <span class="built_in">INT</span>,</span><br><span class="line">   columnn2   <span class="built_in">VARCHAR</span>(<span class="number">10</span>)</span><br><span class="line">) <span class="keyword">DEFAULT</span> <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> hebrew</span><br><span class="line">  <span class="keyword">COLLATE</span> hebrew_general_ci;</span><br></pre></td></tr></table></figure>

<p>一般，MySQL如下确定使用什么样的字符集和校对:</p>
<ul>
<li>如果指定CHARACTER SET和COLLATE两者，则使用这些值。</li>
<li>如果只指定CHARACTER SET，则使用此字符集及其默认的校对（如SHOW CHARACTER SET的结果中所示）。</li>
<li>如果既不指定CHARACTER SET，也不指定COLLATE，则使用数据库默认。</li>
</ul>
<p>MySQL还允许对每个列设置字符集和校正顺序：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> mytable</span><br><span class="line">(</span><br><span class="line">   columnn1   <span class="built_in">INT</span>,</span><br><span class="line">   columnn2   <span class="built_in">VARCHAR</span>(<span class="number">10</span>),</span><br><span class="line">   column3    <span class="built_in">VARCHAR</span>(<span class="number">10</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> latin1 <span class="keyword">COLLATE</span> latin1_general_ci</span><br><span class="line">) <span class="keyword">DEFAULT</span> <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> hebrew</span><br><span class="line">  <span class="keyword">COLLATE</span> hebrew_general_ci;</span><br></pre></td></tr></table></figure>

<p>校对在对用ORDER BY子句检索出来的数据排序时起重要的作用。如果你需要用与创建表时不同的校对顺序排序特定的SELECT语句，可以在SELECT语句自身中进行：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> customers</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> lastname, firstname <span class="keyword">COLLATE</span> latin1_general_cs;</span><br></pre></td></tr></table></figure>

<h2 id="Ch-28-安全管理"><a href="#Ch-28-安全管理" class="headerlink" title="Ch 28.安全管理"></a>Ch 28.安全管理</h2><h3 id="1-访问控制"><a href="#1-访问控制" class="headerlink" title="1.访问控制"></a>1.访问控制</h3><p>MySQL服务器的安全基础是：<em>用户应该对他们需要的数据具有适当的访问权，既不能多也不能少</em>。</p>
<p>MySQL默认数据库的用户root拥有对数据库的绝对管理权限，应该严肃对待root登录的使用。仅在绝对需要时使用它（或许在你不能登录其他管理账号时使用）。不应该在日常的MySQL操作中使用root。</p>
<h3 id="2-管理用户"><a href="#2-管理用户" class="headerlink" title="2.管理用户"></a>2.管理用户</h3><p>MySQL用户账号和信息存储在名为mysql的MySQL数据库中。可以在其中的user表中查询到所有的用户：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">USE</span> mysql;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">user</span> <span class="keyword">FROM</span> <span class="keyword">user</span>;</span><br></pre></td></tr></table></figure>

<p>####创建用户</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> ben <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">'p@$$w0rd'</span>;</span><br></pre></td></tr></table></figure>

<p>####重命名用户</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">RENAME</span> <span class="keyword">USER</span> ben <span class="keyword">TO</span> bforta;</span><br></pre></td></tr></table></figure>

<p>####删除用户</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">USER</span> bforta;</span><br></pre></td></tr></table></figure>

<h4 id="设置访问权限"><a href="#设置访问权限" class="headerlink" title="设置访问权限"></a>设置访问权限</h4><p>新创建的用户没有任何权限，只能登录服务器，不能操作任何表和数据库。</p>
<p>查看权限：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> <span class="keyword">GRANTS</span> <span class="keyword">FOR</span> bforta;</span><br><span class="line"></span><br><span class="line"><span class="comment">#输出为</span></span><br><span class="line">+<span class="comment">-------------------------------------------------+</span></span><br><span class="line">| Grants for bforta@%                             |</span><br><span class="line">+<span class="comment">-------------------------------------------------+</span></span><br><span class="line">| <span class="keyword">GRANT</span> <span class="keyword">USAGE</span> <span class="keyword">ON</span> *.* <span class="keyword">TO</span> <span class="string">'bforta'</span>@<span class="string">'%'</span>              |</span><br><span class="line">+<span class="comment">-------------------------------------------------+</span></span><br></pre></td></tr></table></figure>

<p><code>ON*.*</code>表示在任意数据库和任意表上对任何东西没有权限。</p>
<p>另外，“MySQL的权限用用户名和主机名结合定义，即<code>user@host</code>。如果不指定主机名，则使用默认的主机名%（授予用户访问权限而不管主机名）。</p>
<p>可以使用 GRANT 语句授予用户权限，</p>
<ul>
<li>要授予的权限；</li>
<li>被授予访问权限的数据库或表；</li>
<li>用户名。</li>
</ul>
<p>以下例子给出GRANT的用法：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GRANT</span> <span class="keyword">SELECT</span> <span class="keyword">ON</span> crashcourse.* <span class="keyword">TO</span> beforta;</span><br></pre></td></tr></table></figure>

<p>这条语句授予beforta用户对crashcourse数据库中所有的表上使用SELECT语句的权限。</p>
<p>可以使用REVOKE语句来撤销GRANT授予的权限：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">REVOKE</span> <span class="keyword">SELECT</span> <span class="keyword">ON</span> crashcourse.* <span class="keyword">FROM</span> beforta</span><br></pre></td></tr></table></figure>

<p>GRANT和REVOKE可在几个层次上控制访问权限：</p>
<ul>
<li>整个服务器，使用GRANT ALL和REVOKE ALL；</li>
<li>整个数据库，使用ON database.*；</li>
<li>特定的表，使用ON database.table；</li>
<li>特定的列；</li>
<li>特定的存储过程。</li>
</ul>
<p>以下是具体权限内容：</p>
<p><img src="http://ww1.sinaimg.cn/large/b473b473gy1gfyreafm49j214e13sq97.jpg" alt="WX20200620-145326@2x.png"></p>
<p>可通过列出各权限并用逗号分隔，将多条GRANT语句串在一起，如下所示：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GRANT</span> <span class="keyword">SELECT</span>, <span class="keyword">INSERT</span> <span class="keyword">ON</span> crashcourse.* <span class="keyword">TO</span> beforta;</span><br></pre></td></tr></table></figure>

<h4 id="更改口令"><a href="#更改口令" class="headerlink" title="更改口令"></a>更改口令</h4><p>可以使用下列语句更改口令：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> <span class="keyword">PASSWORD</span> <span class="keyword">FOR</span> bforta = <span class="keyword">Password</span>(<span class="string">'n3w p@$$w0rd'</span>);</span><br></pre></td></tr></table></figure>

<p>新口令必须传递到Password()函数进行加密。</p>
<h2 id="Ch-29-数据库维护"><a href="#Ch-29-数据库维护" class="headerlink" title="Ch 29.数据库维护"></a>Ch 29.数据库维护</h2><h3 id="1-备份数据"><a href="#1-备份数据" class="headerlink" title="1.备份数据"></a>1.备份数据</h3><p>对数据库进行备份主要有以下几种方式：</p>
<ul>
<li>在MySQL命令行使用<code>mysqldump</code>将所有数据库内容存储到某个外部文件中；</li>
<li>在MySQL命令行使用<code>mysqlhotcopy</code>从一个数据库复制所有数据（并非所有的数据库引擎都支持）；</li>
<li>可以使用MySQL的<code>BACKUP TABLE</code>或<code>SELECT INTO OUTFILE</code>转储所有数据到某个外部文件。数据可以用<code>RESTORE TABLE</code>来复原。</li>
</ul>
<p><strong>注意：</strong>为了保证所有数据被写到磁盘（包括索引数据），可能需要在进行备份前使用<code>FLUSH TABLES</code>语句。</p>
<h3 id="2-进行数据库维护"><a href="#2-进行数据库维护" class="headerlink" title="2.进行数据库维护"></a>2.进行数据库维护</h3><p>应该知道以下语句：</p>
<p><code>ANALYZE TABLE</code>，用来检查表键是否正确。ANALYZE TABLE返回如下所示的状态信息：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ANALYZE</span> <span class="keyword">TABLE</span> orders;</span><br></pre></td></tr></table></figure>

<p><code>CHECK TABLE</code>用来针对许多问题对表进行检查。CHECK TABLE支持一系列的用于MyISAM引擎表的方式。CHANGED检查自最后一次检查以来改动过的表。EXTENDED执行最彻底的检查，FAST只检查未正常关闭的表，MEDIUM检查所有被删除的链接并进行键检验，QUICK只进行快速扫描。如下所示，CHECK TABLE发现和修复问题：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CHECK</span> <span class="keyword">TABLE</span> orders, orderitems;</span><br></pre></td></tr></table></figure>

<h3 id="3-诊断启动问题"><a href="#3-诊断启动问题" class="headerlink" title="3.诊断启动问题"></a>3.诊断启动问题</h3><p>在排除系统启动问题时，首先应该尽量用手动启动服务器。MySQL服务器自身通过在命令行上执行mysqld启动。下面是几个重要的mysqld命令行选项：</p>
<ul>
<li>–help显示帮助——一个选项列表；</li>
<li>–safe-mode装载减去某些最佳配置的服务器；</li>
<li>–verbose显示全文本消息（为获得更详细的帮助消息与–help联合使用）；</li>
<li>–version显示版本信息然后退出。</li>
</ul>
<h3 id="4-查看日志文件"><a href="#4-查看日志文件" class="headerlink" title="4.查看日志文件"></a>4.查看日志文件</h3><p>MySQL维护管理员依赖的一系列日志文件。主要的日志文件有以下几种：</p>
<ul>
<li>错误日志。它包含启动和关闭问题以及任意关键错误的细节。此日志通常名为hostname.err，位于data目录中。此日志名可用–log-error命令行选项更改。</li>
<li>查询日志。它记录所有MySQL活动，在诊断问题时非常有用。此日志文件可能会很快地变得非常大，因此不应该长期使用它。此日志通常名为hostname.log，位于data目录中。此名字可以用–log命令行选项更改。</li>
<li>二进制日志。它记录更新过数据（或者可能更新过数据）的所有语句。此日志通常名为hostname-bin，位于data目录内。此名字可以用–log-bin命令行选项更改。注意，这个日志文件是MySQL 5中添加的，以前的MySQL版本中使用的是更新日志。</li>
<li>缓慢查询日志。顾名思义，此日志记录执行缓慢的任何查询。这个日志在确定数据库何处需要优化很有用。此日志通常名为hostname-slow.log，位于data目录中。此名字可以用–log-slow-queries命令行选项更改。</li>
</ul>
<h2 id="Ch-30-改善性能"><a href="#Ch-30-改善性能" class="headerlink" title="Ch 30.改善性能"></a>Ch 30.改善性能</h2><p>数据库管理员把他们生命中的相当一部份时间花在了调整、试验以改善DBMS性能之上。在诊断应用的滞缓现象和性能问题时，性能不良的数据库（以及数据库查询）通常是最常见的祸因。</p>
<p>回顾之前的章节，总结了一下的几个性能Tips：</p>
<ul>
<li>首先，MySQL（与所有DBMS一样）具有特定的硬件建议。在学习和研究MySQL时，使用任何旧的计算机作为服务器都可以。但对用于生产的服务器来说，应该坚持遵循这些硬件建议。</li>
<li>一般来说，关键的生产DBMS应该运行在自己的专用服务器上。</li>
<li>MySQL是用一系列的默认设置预先配置的，从这些设置开始通常是很好的。但过一段时间后你可能需要调整内存分配、缓冲区大小等。（为查看当前设置，可使用SHOW VARIABLES;和SHOW STATUS;。）</li>
<li>MySQL是一个多用户多线程的DBMS，换言之，它经常同时执行多个任务。如果这些任务中的某一个执行缓慢，则所有请求都会执行缓慢。如果你遇到显著的性能不良，可使用SHOW PROCESS LIST显示所有活动进程（以及它们的线程ID和执行时间）。你还可以用KILL命令终结某个特定的进程（使用这个命令需要作为管理员登录）。</li>
<li>总是有不止一种方法编写同一条SELECT语句。应该试验联结、并、子查询等，找出最佳的方法。</li>
<li>使用EXPLAIN语句让MySQL解释它将如何执行一条SELECT语句。</li>
<li>一般来说，存储过程执行得比一条一条地执行其中的各条MySQL语句快。</li>
<li>应该总是使用正确的数据类型。</li>
<li>决不要检索比需求还要多的数据。换言之，不要用SELECT*（除非你真正需要每个列）。</li>
<li>有的操作（包括INSERT）支持一个可选的DELAYED关键字，如果使用它，将把控制立即返回给调用程序，并且一旦有可能就实际执行该操作。</li>
<li>在导入数据时，应该关闭自动提交。你可能还想删除索引（包括FULLTEXT索引），然后在导入完成后再重建它们。</li>
<li>必须索引数据库表以改善数据检索的性能。确定索引什么不是一件微不足道的任务，需要分析使用的SELECT语句以找出重复的WHERE和ORDER BY子句。如果一个简单的WHERE子句返回结果所花的时间太长，则可以断定其中使用的列（或几个列）就是需要索引的对象。</li>
<li>你的SELECT语句中有一系列复杂的OR条件吗？通过使用多条SELECT语句和连接它们的UNION语句，你能看到极大的性能改进。</li>
<li>索引改善数据检索的性能，但损害数据插入、删除和更新的性能。如果你有一些表，它们收集数据且不经常被搜索，则在有必要之前不要索引它们。（索引可根据需要添加和删除。）</li>
<li>LIKE很慢。一般来说，最好是使用FULLTEXT而不是LIKE。</li>
<li>数据库是不断变化的实体。一组优化良好的表一会儿后可能就面目全非了。由于表的使用和内容的更改，理想的优化和配置也会改变。</li>
<li>最重要的规则就是，每条规则在某些条件下都会被打破。</li>
</ul>
<p>以上差不多就是《MySQL 必知必会》这本书的全部内容了，这本书深入浅出对MySQL数据库进行了一个整体的介绍。但是我们的高性能SQL的计划才刚刚开始。</p>
<p>未完待续······</p>

  </article>
  <aside class="table-content" id="site-toc">
  <div class="table-content-title">
    <i class="fa fa-arrow-right fa-lg" id="site-toc-hide-btn"></i>
    <span>目录</span>
  </div>
  <div class="table-content-main">
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#高性能-SQL-计划-Day-5"><span class="toc-text">高性能 SQL 计划 Day 5</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Ch-23-使用存储过程"><span class="toc-text">Ch 23.使用存储过程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-存储过程的优缺点："><span class="toc-text">1.存储过程的优缺点：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-使用存储过程"><span class="toc-text">2.使用存储过程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#调用存储过程"><span class="toc-text">调用存储过程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#创建存储过程"><span class="toc-text">创建存储过程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#删除存储过程"><span class="toc-text">删除存储过程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#使用参数"><span class="toc-text">使用参数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#建立智能存储过程"><span class="toc-text">建立智能存储过程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#检查存储过程"><span class="toc-text">检查存储过程</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Ch-24-使用游标"><span class="toc-text">Ch 24.使用游标</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-使用游标"><span class="toc-text">1.使用游标</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#定义游标"><span class="toc-text">定义游标</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#打开和关闭游标"><span class="toc-text">打开和关闭游标</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#使用游标数据"><span class="toc-text">使用游标数据</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Ch-25-使用触发器"><span class="toc-text">Ch 25.使用触发器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-创建触发器"><span class="toc-text">1.创建触发器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-删除触发器"><span class="toc-text">2.删除触发器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-使用触发器"><span class="toc-text">3.使用触发器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#INSERT触发器"><span class="toc-text">INSERT触发器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#DELETE触发器"><span class="toc-text">DELETE触发器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#UPDATE触发器"><span class="toc-text">UPDATE触发器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#注意事项"><span class="toc-text">注意事项</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Ch-26-管理事务处理"><span class="toc-text">Ch 26.管理事务处理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-控制事务处理"><span class="toc-text">1.控制事务处理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#使用ROLLBACK"><span class="toc-text">使用ROLLBACK</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#使用COMMIT"><span class="toc-text">使用COMMIT</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#使用保留点"><span class="toc-text">使用保留点</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-更改默认的自动提交"><span class="toc-text">2.更改默认的自动提交</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Ch-27-全球化和本地化"><span class="toc-text">Ch 27.全球化和本地化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-使用字符集和校正顺序"><span class="toc-text">1.使用字符集和校正顺序</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Ch-28-安全管理"><span class="toc-text">Ch 28.安全管理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-访问控制"><span class="toc-text">1.访问控制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-管理用户"><span class="toc-text">2.管理用户</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#设置访问权限"><span class="toc-text">设置访问权限</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#更改口令"><span class="toc-text">更改口令</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Ch-29-数据库维护"><span class="toc-text">Ch 29.数据库维护</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-备份数据"><span class="toc-text">1.备份数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-进行数据库维护"><span class="toc-text">2.进行数据库维护</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-诊断启动问题"><span class="toc-text">3.诊断启动问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-查看日志文件"><span class="toc-text">4.查看日志文件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Ch-30-改善性能"><span class="toc-text">Ch 30.改善性能</span></a></li></ol></li></ol>
  </div>
</aside>
  
    <aside class="passage-copyright">
      <div>本文作者: 刘点石</div>
      
        <div>
          原文链接: 
          <a href="" target="_blank">https://dianshiblog.github.io/passages/2020-6-20-SQL-5/</a>
        </div>
      
      <div>
        版权声明: 本博客所有文章除特别声明外, 均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议. 转载请注明出处!
      </div>
    </aside>
  
  
    <div class="passage-tags">
     
      <a href="/tags/Java/"><i class="fa fa-tags"></i>Java</a>
     
      <a href="/tags/MySQL/"><i class="fa fa-tags"></i>MySQL</a>
    
    </div>
  
</div>

    </main>
    
    <div class="site-footer-wrapper">
  <footer class="site-footer">
    
      
        <div class="site-footer-col">
          <h5 class="site-footer-title">博客推荐</h5>
          
            <span class="site-footer-item">
              <a href="https://godbmw.com/" target="_blank">GodBMW</a>
            </span>
          
            <span class="site-footer-item">
              <a href="http://ruanyifeng.com/" target="_blank">阮一峰的个人网站</a>
            </span>
          
        </div>
      
        <div class="site-footer-col">
          <h5 class="site-footer-title">系列教程</h5>
          
            <span class="site-footer-item">
              <a href="" target="_self">暂无</a>
            </span>
          
        </div>
      
        <div class="site-footer-col">
          <h5 class="site-footer-title">抓到我</h5>
          
            <span class="site-footer-item">
              <a href="https://weibo.com/u/3027481715" target="_blank">微博</a>
            </span>
          
        </div>
      
    
    <div class="site-footer-info">
      <i class="fa fa-clock-o"></i> 本站已稳定运行<span id="site-time"></span>
    </div>
    
      <div class="site-footer-info">
        <i class="fa fa-paw"></i> 您是本站第 <span id="site-count"></span> 位访客
      </div>
    
    
      <div class="site-footer-info">
        <i class="fa fa-at"></i> Email: dianshiliu@163.com
      </div>
    
    <div class="site-footer-info">
      <i class="fa fa-copyright"></i> 
      2019 <a href="https://github.com/dongyuanxin/theme-ad/" target="_blank">Theme-AD</a>.
      Created by <a href="https://godbmw.com/" target="_blank">GodBMW</a>.
      All rights reserved.
    </div>
  </footer>
</div>
    <div id="site-layer" style="display:none;">
  <div class="site-layer-content">
    <div class="site-layer-header">
      <span class="site-layer-header-title" id="site-layer-title"></span>
      <i class="fa fa-close" id="site-layer-close"></i>
    </div>
    <div class="site-layer-body" id="site-layer-container">
      <div class="site-layer-input" id="site-layer-search" style="display: none;">
        <div class="site-layer-input-choose">
          <a href="javascript:void(0);" title="Change Search Engine">Google</a>
        </div>
        <input type="text">
        <i class="fa fa-search"></i>
      </div>
      
      <div id="site-layer-welcome" style="display:none;"></div>
    </div>
  </div>
</div>
    

<div class="bottom-bar">
  <div class="bottom-bar-left">
    <a href="javascript:void(0);" data-enable="false">
      <i class="fa fa-arrow-left"></i>
    </a>
    <a href="/passages/2020-6-16-SQL-4/" data-enable="true">
      <i class="fa fa-arrow-right"></i>
    </a>
  </div>
  <div class="bottom-bar-right">
    <a href="javascript:void(0);" data-enable="true" id="site-toc-show-btn">
      <i class="fa fa-bars"></i>
    </a>
    
    <a href="javascript:void(0);" id="site-toggle-share-btn">
      <i class="fa fa-share-alt"></i>
    </a>
    
    <a href="javascript:void(0);" id="back-top-btn">
      <i class="fa fa-chevron-up"></i>
    </a>
  </div>
</div>
    <div id="share-btn">
  
    <a id="share-btn-twitter" href="javascript:void(0);" target="_blank">
      <i class="fa fa-twitter"></i>
    </a>
  
  
    <a id="share-btn-facebook" href="javascript:void(0);" target="_blank">
      <i class="fa fa-facebook"></i>
    </a>
  
  
    <a id="share-btn-weibo" href="javascript:void(0);" target="_blank">
      <i class="fa fa-weibo"></i>
    </a>
  
  
    <a id="share-btn-qq" href="javascript:void(0);" target="_blank">
      <i class="fa fa-qq"></i>
    </a>
  
  
    <a id="share-btn-wechat" href="javascript:void(0);" target="_blank">
      <i class="fa fa-wechat"></i>
    </a>
  
</div>
    





    
  </body>
</html>